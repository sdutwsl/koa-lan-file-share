<html>

<head>
    <title>目录树</title>
</head>

<body>
    <div>
        <ul id="Explorer">
        </ul>
        <div id="404" style="display: none;">
            <p>This dir is <strong>Not Found</strong>.</p>
        </div>
    </div>
    <template id="FileItem">
        <li>
            <div>
                <svg id="SvgDir" width="1em" height="1em" t="1604244220931" class="icon" viewBox="0 0 1024 1024"
                    version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1314" width="200" height="200">
                    <path d="M211.37408 477.63456h606.1056v40.96H211.37408z" fill="" p-id="1315"></path>
                    <path
                        d="M837.95968 815.65696H190.95552l-0.06144-20.48V242.52416h240.06656l106.8032 62.62784h300.19584v510.50496z m-606.1056-40.96h565.1456V346.112H526.6432L419.84 283.48416h-187.98592v491.2128z"
                        fill="" p-id="1316"></path>
                </svg>
                <svg id="SvgFile" width="1em" height="1em" t="1604244330193" class="icon" viewBox="0 0 1024 1024"
                    version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2814" width="200" height="200">
                    <path d="M313.0368 429.40416h399.36v40.96h-399.36zM313.0368 618.86464h399.36v40.96h-399.36z" fill=""
                        p-id="2815"></path>
                    <path
                        d="M816.20992 823.86944H209.26464V200.13056h478.35136l128.57344 134.22592v489.51296z m-565.98528-40.96h525.02528V350.8224l-105.10336-109.73184H250.22464v541.81888z"
                        fill="" p-id="2816"></path>
                </svg>
                <a id="FileName" href="#"></a>
                <span id="FileType" style="color:red;"></span>
            </div>
        </li>
    </template>
    <script>
        //服务端地址
        const server_url = "http://localhost:3000"
        //服务端文件夹树
        let server_dirs = null

        //获取浏览器路径
        const get_hash_dirs = () => {
            let dirs = window.location.hash.substr(1, window.location.hash.length).split("/")
            //多输入了/的情况
            for (let d = 0; d < dirs.length; d++) {
                if (dirs[d] === "") {
                    dirs.splice(d, 1)
                    d--
                }
            }
            return dirs
        }

        //根据浏览器的文件夹获取服务器的文件夹及子文件
        const get_current_dir = (server_dir, dirs) => {
            let not_found = false
            for (let dir in dirs) {
                let aim_dir = server_dir.subs.find(d => d.name === dirs[dir])
                if (aim_dir) {
                    server_dir = aim_dir
                    continue
                } else {
                    not_found = true
                    break
                }
            }
            if (!not_found) {
                return server_dir
            } else {
                return undefined
            }
        }

        //绑定hash改变事件
        window.onhashchange = () => {
            let current_dir = get_current_dir(server_dirs, get_hash_dirs())
            //服务端没有输入的文件夹
            if (!current_dir) {
                console.log("Not Found!")
            } else {
                render_lists(current_dir)
            }
        }

        //将文件夹渲染到列表上
        const render_lists = dir => {
            //修改标题
            document.title = dir.name
            //清空列表
            let explorer = document.querySelector("#Explorer")
            explorer.innerHTML = ""
            //插入新节点
            let t = document.querySelector("#FileItem")
            let a = t.content.querySelector("#FileName")
            let s = t.content.querySelector("#FileType")
            let svg_dir = t.content.querySelector("#SvgDir")
            let svg_file = t.content.querySelector("#SvgFile")
            console.log(svg_file, svg_dir)
            //不是根目录添加返回上级
            if (window.location.hash !== "") {
                a.innerText = ".."
                let hash = window.location.hash
                //TODO:增加返回
                hash = hash.substr(0, hash.length - dir.name.length)
                console.log(hash)
                a.removeAttribute("download")
                s.innerText = "dir"
            }
            dir.subs.forEach(element => {
                a.innerText = element.name
                if (element.dir) {
                    a.href = window.location + "/" + element.name
                    a.removeAttribute("download")
                    s.innerText = "dir"
                    svg_dir.setAttribute("style", "display:inline;")
                    svg_file.setAttribute("style", "display:none;")
                } else {
                    let href = window.location.toString().replace("#", "/") + "/" + element.name
                    //各种/////换成/
                    href = href.replace(/\/+/g, "/")
                    //去掉f**king http(s)
                    a.setAttribute("href", "/" + href.replace(/https?:/, ""))
                    a.setAttribute("download", element.name)
                    s.innerText = "file"
                    svg_dir.setAttribute("style", "display:none;")
                    svg_file.setAttribute("style", "display:file;")
                }
                let clone = document.importNode(t.content, true)
                explorer.appendChild(clone)
                return true
            });
        }
        //获取服务端文件树
        fetch(server_url + "/ListFiles").then(res => {
            if (res.status == 200) {
                res.json().then(obj => {
                    server_dirs = obj
                    //触发一次渲染
                    window.onhashchange()
                    //如果没有# 则加上 否则点击链接就会生成错误的地址
                    if (window.location.href.toString().indexOf("#") === -1)
                        window.location.href = window.location.href + "#"
                })
            }
        })
    </script>
</body>

</html>